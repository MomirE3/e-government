<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Survey</title>
  </head>
  <body>
    <h1>Survey</h1>
    <div id="questions"></div>
    <button id="submit">Submit</button>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');

      async function loadQuestions() {
        const res = await fetch(`/surway/participants/${token}`);
        if (!res.ok) {
          document.getElementById('questions').innerText =
            'Invalid or expired link.';
          return;
        }
        const participant = await res.json();

        const container = document.getElementById('questions');
        participant.survey.questions.forEach((q) => {
          const label = document.createElement('label');
          label.innerText = q.text;
          const input = document.createElement('input');
          input.type = 'text';
          input.name = q.id;
          container.appendChild(label);
          container.appendChild(input);
          container.appendChild(document.createElement('br'));
        });
      }

      document.getElementById('submit').onclick = async () => {
        const inputs = document.querySelectorAll('input');
        const answers = Array.from(inputs).map((inp) => ({
          value: inp.value,
          questionId: parseInt(inp.name),
          participantToken: token,
        }));

        const res = await fetch(`/surway/participants/${token}/answers`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ answers }),
        });

        if (res.ok) {
          alert('Survey submitted successfully!');
        } else {
          alert('Error submitting survey.');
        }
      };

      loadQuestions();
    </script>
  </body>
</html>
